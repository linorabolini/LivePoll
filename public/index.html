<head>
    <meta charset="UTF-8" />
    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.11/lodash.min.js"></script>
    <script src="./socket.io.js"></script>
    <script type="text/babel">
        // get session from url params
        const urlParams = new URLSearchParams(window.location.search)
        const session = urlParams.get("session")

        // get user from somewhere
        const user = urlParams.get("user")

        // init the connection
        const socket = io(window.location.href)

        const defaultVote = {
            sound: 0
        }

        const Button = ({ phase, data, ...props }) => (
            <button
                onClick={e =>
                    socket.emit("vote", {
                        session,
                        user,
                        phase,
                        data
                    })
                }
                {...props}
            />
        )

        const App = props => {
            const { data = [] } = props
            const phase = Math.max(data.length - 1, 0)
            const vote = _.get(data, `${phase}.${user}`, defaultVote)
            return (
                <React.Fragment>
                    <Button
                        phase={phase}
                        data={{ ...vote, sound: vote.sound + 1 }}
                        children="ADD"
                    />
                    <Button
                        phase={phase}
                        data={{ ...vote, sound: vote.sound - 1 }}
                        children="REMOVE"
                    />
                    <pre>{JSON.stringify(props, null, 2)}</pre>
                </React.Fragment>
            )
        }

        socket.on(`sessions.${session}`, data => {
            ReactDOM.render(<App data={data} />, document.getElementById("root"))
        })

        alert("Pentagrama live")
    </script>
</head>

<div id="root"></div>
