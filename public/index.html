<head>
    <meta charset="UTF-8" />
    <meta
        name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <script src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
    <script src="https://unpkg.com/lodash@4.17.11/lodash.min.js"></script>
    <script src="./socket.io.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: white;
        }

        .tiles {
            display: flex;
            flex-flow: row wrap;
            align-content: center;
            align-items: stretch;
            justify-content: 1rem;
        }

        .tile {
            font: inherit;
            display: block;
            box-sizing: content-box;
            font-size: inherit;
            flex: 1 0 20%;
            height: 15vh;
            line-height: 15vh;
            text-align: center;
            color: white;
            user-select: none;
            font-family: Arial, Helvetica, sans-serif;
            padding: 1rem;
            background-color: #009688;
            border: 1px solid;
        }

        .title {
            text-align: center;
            text-transform: capitalize;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 2rem;
            padding: 1rem;
        }

        .tile:disabled {
            opacity: 0.5;
        }
    </style>
    <script type="text/babel">
        // get session from url params
        const urlParams = new URLSearchParams(window.location.search)
        const session = urlParams.get("session")

        // init the connection
        const socket = io(window.location.href)

        const Tiles = props => <div className="tiles" {...props} />

        const Tile = ({ phase, data, ...props }) => (
            <button
                className="tile"
                onClick={e =>
                    socket.emit("vote", {
                        session,
                        phase,
                        data
                    })
                }
                {...props}
            />
        )

        const App = props => {
            const { data = [], address, configs } = props
            const phase = Math.max(data.length - 1, 0)
            const vote = _.get(data, `${phase}.${address}`, {})
            return (
                <div>
                    {configs.map(c => (
                        <div className="tilesWrapper">
                            <div className="title">{c.label || c.key}</div>
                            <Tiles>
                                {c.options.map(o => (
                                    <Tile
                                        phase={phase}
                                        data={{ ...vote, [c.key]: o.value }}
                                        disabled={vote[c.key] === o.value}
                                        children={o.label}
                                    />
                                ))}
                            </Tiles>
                        </div>
                    ))}
                </div>
            )
        }

        socket.on(`sessions/${session}`, (data, address, configs) => {
            ReactDOM.render(
                <App data={data} address={address} configs={configs} />,
                document.getElementById("root")
            )
        })

        // alert("Pentagrama live")
    </script>
</head>

<div id="root"></div>
